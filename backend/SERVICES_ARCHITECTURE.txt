================================================================================
BACKEND SERVICES ARCHITECTURE DIAGRAM
================================================================================

CURRENT STATE:
==============

┌─────────────────────────────────────────────────────────────────────────────┐
│                           FastAPI Application                              │
│                            (main.py)                                       │
└────────────────────┬──────────────────────────────────────────┬─────────────┘
                     │                                          │
        ┌────────────┴────────────┐                   ┌─────────┴──────────┐
        │                         │                   │                    │
    ┌───▼────────────┐      ┌────▼──────────────┐   ┌▼──────────────┐  ┌──▼───────┐
    │   /api/auth    │      │  /api/sessions    │   │  /api/patients│  │  /health │
    │   (router.py)  │      │  (sessions.py)    │   │  (patients.py)│  │  (main) │
    └────────────────┘      └────┬──────────────┘   └───────────────┘  └──────────┘
                                 │
                    ┌────────────┴────────────┐
                    │                         │
        ┌───────────▼──────────┐    ┌────────▼─────────────┐
        │  Transcription       │    │ Note Extraction     │
        │  Service             │    │ Service             │
        │  (27 lines)          │    │ (187 lines)         │
        ├──────────────────────┤    ├─────────────────────┤
        │                      │    │                     │
        │ Function-based:      │    │ Class-based:        │
        │ transcribe_audio()   │    │ NoteExtractionSrvc  │
        │                      │    │                     │
        │ Issues:              │    │ Issues:             │
        │ - No error handling  │    │ - No DI pattern     │
        │ - Fragile paths      │    │ - Sync in async     │
        │ - Vague return type  │    │ - Global singleton  │
        │ - Silent operation   │    │ - Hardcoded paths   │
        │                      │    │ - No retries        │
        └──────────┬───────────┘    └────────┬────────────┘
                   │                         │
        ┌──────────▼──────────┐   ┌─────────▼──────────────┐
        │  Audio Pipeline     │   │   OpenAI API (GPT-4o)  │
        │  (external package) │   │   (Cloud service)      │
        │                     │   │                        │
        │ - Whisper API       │   │ - $2.50 per 1M input   │
        │ - Speaker diarization   │ - $10.00 per 1M output │
        │ - Role labeling     │   │                        │
        └─────────────────────┘   └────────────────────────┘


DATA FLOW:
==========

User Upload → sessions.py:upload_audio_session()
              ↓
         [DB: Create Session Record]
              ↓
         [Background Task: process_audio_pipeline]
              ├→ transcribe_audio_file() 
              │  └→ AudioTranscriptionPipeline()
              │     └→ [Update DB: transcript_text]
              │
              └→ get_extraction_service()
                 └→ NoteExtractionService.extract_notes()
                    └→ OpenAI API
                       └→ [Update DB: extracted_notes]


DEPENDENCY GRAPH (Service-to-Service):
======================================

transcription.py
  ├─ imports: sys, Path, typing
  ├─ imports: AudioTranscriptionPipeline (EXTERNAL)
  └─ NO dependencies on other services

note_extraction.py
  ├─ imports: json, time, typing, openai
  ├─ imports: app.models.schemas (SCHEMAS)
  ├─ imports: os, dotenv
  └─ NO dependencies on other services

sessions.py (ROUTER - consumes services)
  ├─ imports: transcription.transcribe_audio_file
  ├─ imports: note_extraction.get_extraction_service
  ├─ imports: database, models, auth
  └─ orchestrates service calls in process_audio_pipeline()

DEPENDENCY ISSUES:
  - Services have ZERO dependencies (good modularity)
  - BUT: Tight coupling IN routers (import at module level)
  - NO central service registry
  - NO factory pattern


ENVIRONMENT & CONFIG SOURCES:
=============================

database.py
  └─ load_dotenv("../audio-transcription-pipeline/.env")
     └─ DATABASE_URL, OPENAI_API_KEY

note_extraction.py
  └─ load_dotenv("../audio-transcription-pipeline/.env")
     └─ OPENAI_API_KEY (same file!)

transcription.py
  └─ sys.path.insert(0, PIPELINE_DIR)
     └─ hardcoded path navigation

FRAGMENTATION ISSUES:
  - load_dotenv() called multiple times (same file)
  - Config scattered across modules
  - Path setup duplicated
  - NO centralized configuration


PROPOSED IMPROVED ARCHITECTURE:
===============================

┌─────────────────────────────────────────────────────────────────────────────┐
│                     FastAPI Application (main.py)                          │
│                                                                             │
│   ┌───────────────────────────────────────────────────────────────────┐    │
│   │  app.lifespan():                                                  │    │
│   │    - load_dotenv() once                                           │    │
│   │    - initialize config (Settings)                                │    │
│   │    - create service container                                     │    │
│   │    - inject into app.state                                        │    │
│   └───────────────────────────────────────────────────────────────────┘    │
└────────────────────┬──────────────────────────────────────────────────┬─────┘
                     │                                                  │
        ┌────────────┴────────┐              ┌───────────────┬─────────┴──┐
        │                     │              │               │             │
    ┌───▼───────────┐   ┌────▼──────────┐  ┌▼────────┐  ┌──▼───────┐  ┌──▼───┐
    │    /api/auth  │   │ /api/sessions │  │ /patients│  │ /health │  │ Deps │
    └───────────────┘   └────┬──────────┘  └─────────┘  └─────────┘  │Inject│
                              │                                       │d Svcs│
                    ┌─────────┴─────────┐                             └──────┘
                    │                   │
        ┌───────────▼──────────┐  ┌────▼────────────────┐
        │  BaseService         │  │ NoteExtractionSrvc  │
        │  (base.py - NEW)     │  │ (improved)          │
        │                      │  │                     │
        │ Provides:            │  │ Extends: BaseService│
        │ - async context mgr  │  │ - async OpenAI      │
        │ - retry decorator    │  │ - error handling    │
        │ - timeout handling   │  │ - proper logging    │
        │ - logging base       │  │ - DI support        │
        └────────┬─────────────┘  └───────┬─────────────┘
                 │                        │
        ┌────────▼────────────┐   ┌──────▼──────────┐
        │ TranscriptionSrvc   │   │ Config (NEW)    │
        │ (class - refactored)│   │ (config.py)     │
        │                     │   │                 │
        │ Extends: BaseService│   │ Settings:       │
        │ - error handling    │   │ - openai_key    │
        │ - return typing     │   │ - db_url        │
        │ - logging           │   │ - pipeline_dir  │
        │ - caching           │   │ - timeouts      │
        └─────────────────────┘   │ - retry_counts  │
                                  └─────────────────┘

        SERVICE CONTAINER (created in main):
        ┌───────────────────────────────────────────┐
        │ def create_services(config):              │
        │   return {                                │
        │     "transcription": TranscriptionSrvc(), │
        │     "extraction": NoteExtractionSrvc()    │
        │   }                                       │
        └───────────────────────────────────────────┘


KEY IMPROVEMENTS:
=================

1. CONFIG MANAGEMENT
   BEFORE: Scattered load_dotenv() calls
   AFTER:  Pydantic Settings, loaded once in main.py

2. DEPENDENCY INJECTION
   BEFORE: get_extraction_service() global singleton
   AFTER:  Fastapi.Depends() injection per request

3. SERVICE BASE CLASS
   BEFORE: Each service reinvents error handling
   AFTER:  BaseService with retry, timeout, logging decorators

4. ASYNC SUPPORT
   BEFORE: sync OpenAI client blocking event loop
   AFTER:  AsyncOpenAI with proper await

5. ERROR HANDLING
   BEFORE: Exceptions bubble up unhandled (~5% coverage)
   AFTER:  Structured error types, retry logic, graceful fallback

6. TESTING
   BEFORE: 0% test coverage, hard to mock
   AFTER:  Mockable services with fixtures

================================================================================

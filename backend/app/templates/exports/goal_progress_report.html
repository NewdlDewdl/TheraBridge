{% extends "base.html" %}

{% block title %}Goal Progress Report - {{ patient_name }}{% endblock %}

{% block header %}
<h1>Goal Progress Report</h1>
<p><strong>Patient:</strong> {{ patient_name }}</p>
<p><strong>Report Period:</strong> {{ start_date.strftime('%B %d, %Y') }} - {{ end_date.strftime('%B %d, %Y') }}</p>
{% endblock %}

{% block content %}
<!-- Summary Statistics Section -->
<div class="section">
    <div class="section-title">Summary Statistics</div>
    <table>
        <tbody>
            <tr>
                <td><strong>Total Goals Tracked:</strong></td>
                <td>{{ summary_stats.total_goals }}</td>
            </tr>
            <tr>
                <td><strong>Average Completion Rate:</strong></td>
                <td>{{ summary_stats.avg_completion_rate }}%</td>
            </tr>
            <tr>
                <td><strong>Completed Goals:</strong></td>
                <td>{{ summary_stats.completed_count }}</td>
            </tr>
            <tr>
                <td><strong>In Progress Goals:</strong></td>
                <td>{{ summary_stats.in_progress_count }}</td>
            </tr>
            <tr>
                <td><strong>Assigned Goals:</strong></td>
                <td>{{ summary_stats.assigned_count }}</td>
            </tr>
            <tr>
                <td><strong>Milestones Achieved:</strong></td>
                <td>{{ summary_stats.total_milestones_achieved }}</td>
            </tr>
        </tbody>
    </table>
</div>

{% if has_data %}
<!-- Treatment Goals Detail Section -->
<div class="section">
    <div class="section-title">Treatment Goals Progress</div>

    {% for goal in goals %}
    <div style="margin-bottom: 30px; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">
        <h3 style="margin-top: 0; color: #333;">{{ goal.description }}</h3>

        <table style="margin-bottom: 15px;">
            <tbody>
                <tr>
                    <td style="width: 30%;"><strong>Category:</strong></td>
                    <td>{{ goal.category }}</td>
                </tr>
                <tr>
                    <td><strong>Status:</strong></td>
                    <td style="text-transform: capitalize;">{{ goal.status.replace('_', ' ') }}</td>
                </tr>
                <tr>
                    <td><strong>Baseline Value:</strong></td>
                    <td>{{ goal.baseline_value if goal.baseline_value is not none else 'N/A' }}</td>
                </tr>
                <tr>
                    <td><strong>Current Value:</strong></td>
                    <td>{{ goal.current_value if goal.current_value is not none else 'N/A' }}</td>
                </tr>
                <tr>
                    <td><strong>Target Value:</strong></td>
                    <td>{{ goal.target_value if goal.target_value is not none else 'N/A' }}</td>
                </tr>
                {% if goal.change is not none %}
                <tr>
                    <td><strong>Change:</strong></td>
                    <td style="color: {% if goal.change < 0 %}#2e7d32{% elif goal.change > 0 %}#c62828{% else %}#666{% endif %};">
                        {{ "%.2f"|format(goal.change) }}
                        {% if goal.change < 0 %}⬇{% elif goal.change > 0 %}⬆{% endif %}
                    </td>
                </tr>
                {% endif %}
                {% if goal.progress_percentage is not none %}
                <tr>
                    <td><strong>Progress to Target:</strong></td>
                    <td>
                        <div style="background-color: #e0e0e0; height: 20px; border-radius: 3px; position: relative; overflow: hidden;">
                            <div style="background-color: #4caf50; height: 100%; width: {{ goal.progress_percentage }}%;"></div>
                            <span style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); font-size: 10pt; font-weight: bold;">
                                {{ "%.1f"|format(goal.progress_percentage) }}%
                            </span>
                        </div>
                    </td>
                </tr>
                {% endif %}
                {% if goal.target_date %}
                <tr>
                    <td><strong>Target Date:</strong></td>
                    <td>{{ goal.target_date.strftime('%B %d, %Y') }}</td>
                </tr>
                {% endif %}
                <tr>
                    <td><strong>Progress Entries:</strong></td>
                    <td>{{ goal.num_entries }} recorded in this period</td>
                </tr>
            </tbody>
        </table>

        {% if goal.milestones_achieved %}
        <div style="margin-top: 15px;">
            <strong>Milestones Achieved in Period:</strong>
            <ul style="margin: 5px 0;">
                {% for milestone in goal.milestones_achieved %}
                <li>
                    {{ milestone.title }}
                    <em style="color: #666;">({{ milestone.achieved_at.strftime('%B %d, %Y') }})</em>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
    </div>
    {% endfor %}
</div>

<!-- Progress Trends Section -->
<div class="section">
    <div class="section-title">Progress Trends (Textual Summary)</div>

    {% set improving_goals = goals | selectattr('change', 'lt', 0) | list %}
    {% set declining_goals = goals | selectattr('change', 'gt', 0) | list %}
    {% set stable_goals = goals | rejectattr('change') | list %}

    {% if improving_goals %}
    <p><strong>Improving Goals ({{ improving_goals|length }}):</strong></p>
    <ul>
        {% for goal in improving_goals %}
        <li>{{ goal.description }} - Improved by {{ "%.2f"|format(abs(goal.change)) }} ({{ "%.1f"|format(abs(goal.change / goal.baseline_value * 100)) if goal.baseline_value else 0 }}%)</li>
        {% endfor %}
    </ul>
    {% endif %}

    {% if declining_goals %}
    <p><strong>Goals Needing Attention ({{ declining_goals|length }}):</strong></p>
    <ul>
        {% for goal in declining_goals %}
        <li>{{ goal.description }} - Change: {{ "%.2f"|format(goal.change) }}</li>
        {% endfor %}
    </ul>
    {% endif %}

    {% if stable_goals %}
    <p><strong>Stable Goals ({{ stable_goals|length }}):</strong> Maintaining current levels</p>
    {% endif %}

    {% if not improving_goals and not declining_goals and not stable_goals %}
    <p>Insufficient data for trend analysis in this period.</p>
    {% endif %}
</div>

{% else %}
<!-- No Data Message -->
<div class="section">
    <div class="section-title">No Goal Data Available</div>
    <p>No treatment goals have been set for this patient, or no progress has been recorded during the reporting period.</p>
    <p><strong>Recommendation:</strong> Work with the patient to establish measurable treatment goals and begin tracking progress.</p>
</div>
{% endif %}

<!-- Clinical Notes Section -->
<div class="section">
    <div class="section-title">Clinical Notes</div>
    {% if summary_stats.total_goals > 0 %}
    <p>
        Patient is actively working on {{ summary_stats.total_goals }} treatment goal(s) with an average completion rate of {{ summary_stats.avg_completion_rate }}%.
        {% if summary_stats.total_milestones_achieved > 0 %}
        {{ summary_stats.total_milestones_achieved }} milestone(s) were achieved during this reporting period, indicating positive engagement with treatment.
        {% endif %}
        {% if summary_stats.completed_count > 0 %}
        {{ summary_stats.completed_count }} goal(s) have been successfully completed.
        {% endif %}
    </p>
    {% else %}
    <p>No treatment goals currently tracked. Consider establishing baseline goals with patient.</p>
    {% endif %}
</div>

{% endblock %}
